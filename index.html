<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Pay Per Use GPT: OpenAI, Gemini, Deepseek</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="style.css" />
    <style></style>
  </head>
  <body>
    <div class="chat-wrapper">
      <div class="chat-header">ü§ñ Hola Cheapskate</div>
      <!--<div class="chat-header">üçâ Free Palestine</div>-->
      <div class="chat-window d-flex flex-column" id="chat-window"></div>
      <div class="chat-input-container fixed-bottom m-3 border-0 bg-dark">
        <div id="attachment-preview" class="mb-2"></div>
        <form id="chat-form">
          <textarea
            id="chat-input"
            rows="1"
            class="form-control bg-dark text-white border-0 mb-2"
            placeholder="Ketik sesuatu..."></textarea>
          <div
            class="d-flex align-items-center gap-2 d-flex align-items-center gap-2 m-2 mb-0">
            <label for="file-input" class="btn btn-sm">
              <i class="fas fas-large fa-paperclip text-white"></i
            ></label>
            <input type="file" id="file-input" class="d-none" />
            <button type="button" class="btn btn-sm ms-auto" id="resetChat">
              <i class="fas fas-large fa-rotate text-white"></i>
            </button>
            <button type="submit" class="btn btn-sm">
              <i class="fas fas-large fa-paper-plane text-white"></i>
            </button>
          </div>
        </form>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function () {
        let history = [];
        
        const scrollToBottom = () =>
          $("#chat-window").scrollTop($("#chat-window")[0].scrollHeight);
        
        $("#chat-input").focus();

        const toBase64 = (file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
          });
        };

        const showLoader = (id) => {
          $("#chat-window").append(
            `<div class="chat-bubble ai-bubble" id="${id}"><div class="loading-circle"></div></div>`
          );
          scrollToBottom();
        };

        $("#chat-form").submit(async function (e) {
          e.preventDefault();
          const message = $("#chat-input").val().trim();
          const file = $("#file-input")[0].files[0];
          if (!message && !file) return;

          let payload = {};

          if (file) {
            const image = await toBase64(file);

            // Menampilkan gambar dan teks jika keduanya ada
            $("#chat-window").append(
              `<div class="chat-bubble user-bubble">
        <img src="${image}" class="user-uploaded mb-2"/><br/>
        ${message ? `<div>${DOMPurify.sanitize(message)}</div>` : ""}
      </div>`
            );

            payload.image_url = image;
            payload.prompt = message || "Analisis gambar ini";
            if (message) history.push({ role: "user", content: message });
          } else if (/gambar|buat gambar|image|ilustrasi|logo/i.test(message)) {
            $("#chat-window").append(
              `<div class="chat-bubble user-bubble">${DOMPurify.sanitize(
                message
              )}</div>`
            );
            payload.generate_image = true;
            payload.prompt = message;
            history.push({ role: "user", content: message });
          } else {
            $("#chat-window").append(
              `<div class="chat-bubble user-bubble">${DOMPurify.sanitize(
                message
              )}</div>`
            );
            history.push({ role: "user", content: message });
            payload.messages = history;
          }

          const loaderId = "loader-" + Date.now();
          showLoader(loaderId);

          $("#chat-input").val("").css("height", "auto");
          $("#file-input").val("");
          $("#attachment-preview").empty();

          fetch("https://round-cake-a592.mkemalw.workers.dev", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((res) => res.json())
            .then((data) => {
              $(`#${loaderId}`).remove();
              const response = data.response;
              if (response.startsWith("http")) {
                $("#chat-window").append(
                  `<div class="chat-bubble ai-bubble"><img src="${response}" class="img-fluid rounded"/></div>`
                );
              } else {
                const html = DOMPurify.sanitize(marked.parse(response));
                $("#chat-window").append(
                  `<div class="chat-bubble ai-bubble">${html}</div>`
                );
                history.push({ role: "assistant", content: response });
                hljs.highlightAll();
              }
              scrollToBottom();
              $("#chat-input").focus();
            })
            .catch((err) => {
              $(`#${loaderId}`).remove();
              console.error("‚ùå Error request ke worker:", err);
              $("#chat-window").append(
                `<div class="chat-bubble ai-bubble text-danger">‚ùå Error dalam memproses request: ${
                  err.message || err
                }</div>`
              );
              scrollToBottom();
              $("#chat-input").focus();
            });
        });

        $("#file-input").change(function () {
          const file = this.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            $("#attachment-preview").html(`
<div class="bg-dark p-2 text-light rounded d-flex align-items-center">
<img src="${e.target.result}" style="width:50px;height:auto" class="rounded me-2"/>
<button type="button" class="btn-close btn-close-white" id="remove-preview"></button>
</div>`);
            $("#remove-preview").click(() => {
              $("#file-input").val("");
              $("#attachment-preview").empty();
            });
            $("#chat-input").focus(); // Memfokuskan kembali ke textarea setelah menambahkan lampiran
          };
          reader.readAsDataURL(file);
        });

        $("#chat-input")
          .keydown((e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              $("#chat-form").submit();
            }
          })
          .on("input", function () {
            $(this).css({ height: "auto", height: this.scrollHeight + "px" });
          });

        $("#resetChat").click(() => {
          $("#chat-window").empty();
          history = [];
        });
      });
    </script>
  </body>
</html>
